%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Introduction to the rmongodb Package}


MongoDB (www.mongodb.org) is a scalable, high-performance, document-oriented NoSQL database. The **rmongodb** package provides an interface from R (www.r-project.org) to MongoDB and back using the mongodb-C library. 

# Installing and Loading rmongodb Package
There is a stable CRAN version of rmongodb available:
```{r, eval=FALSE}
install.packages("rmongodb")
```
You can also install the latest development version from github:
```{r, eval=FALSE}
library(devtools)
install_github("rmongodb", "mongosoup")
```
The installation should very simple. No local MongoDB installation is required. Only if you install from source the RUnit test will need a local MongoDB installation.

Afterwards you can load rmongodb as any other package:
```{r}
library(rmongodb)
```


# First Steps in rmongodb Package

## Connect to MongoDB
```{r}
mongo <- mongo.create()
mongo
mongo.is.connected(mongo)
```

```{r, echo=FALSE}
# load some data
library(jsonlite)
data(zips)
res <- list(length(dim(zips)[1]))
for(i in 1:dim(zips)[1]){
  tmp <- zips[i,] 
  res[[i]] <- mongo.bson.from.list(tmp)
}
mongo.insert.batch(mongo, "rmongodb.zips", res )
```

## Get Databases
```{r}
mongo.get.databases(mongo)
```

## Get Collections
```{r}
db <- "rmongodb"
coll <- "rmongodb.zips"
mongo.get.database.collections(mongo, db)
```

## Get Size of Collection
```{r}
mongo.count(mongo, coll)
```

## Get Values for a Key
```{r}
res <- mongo.distinct(mongo, coll, "city")
head(res)
```

## Find some first data
```{r}
cityone <- mongo.find.one(mongo, coll, '{"city":"COLORADO CITY"}')
cityone
mongo.bson.to.list(cityone)
```

## For a long time it was all about creating BSON objects
Since rmongodb version 1.2 you can use JSON directly.
```{r}
buf <- mongo.bson.buffer.create()
mongo.bson.buffer.append(buf, "city", "COLORADO CITY")
query <- mongo.bson.from.buffer(buf)
query
mongo.bson.from.JSON('{"city":"COLORADO CITY"}')
```

## Find more data
```{r}
pop <- mongo.distinct(mongo, coll, "pop")
hist(pop)
boxplot(pop)

mongo.count(mongo, coll, '{"pop":{"$lte":2}}')
pops <- mongo.find.all(mongo, coll, '{"pop":{"$lte":2}}')
head(pops)
dim(pops)
```

## Find more data with more compley query
```{r}
library(jsonlite)
json <- '{"pop":{"$lte":2}, "pop":{"$gte":1}}'
cat(prettify(json))
validate(json)
mongo.count(mongo, coll, json)
pops <- mongo.find.all(mongo, coll, json)
head(pops)
dim(pops)

# still inefficient!
mongo.cursor.to.data.frame
```

## Insert some data to MongoDB
```{r}
# insert data
icoll <- paste(db, "test", sep=".")
a <- mongo.bson.from.JSON( '{"ident":"a", "name":"Markus", "age":33}' )
b <- mongo.bson.from.JSON( '{"ident":"b", "name":"MongoSoup", "age":1}' )
c <- mongo.bson.from.JSON( '{"ident":"c", "name":"UseR", "age":18}' )
mongo.insert.batch(mongo, icoll, list(a,b,c) )

mongo.get.database.collections(mongo, db)
mongo.find.all(mongo, icoll)
```

## Update documents in MongoDB
```{r}
mongo.update(mongo, icoll, '{"ident":"b"}', '{"$inc":{"age":3}}' )

mongo.find.all(mongo, icoll)
```

## Create indices for efficient queries
```{r}
mongo.index.create(mongo, icoll, '{"ident":1}')
# check mongoshell!
```

## Drop / Remove collections and databases and Close Connection to MongoDB
```{r}
mongo.drop(mongo, icoll)
mongo.drop.database(mongo, db)
mongo.get.database.collections(mongo, db)

# close connection
mongo.destroy(mongo)
```





# Advanced Steps in rmongodb Package

```{r}
mongo <- mongo.create()
```

## Insert Big Data
```{r}
data(zips)
head(zips)
zips[1,]$loc

res <- list(length(dim(zips)[1]))
for(i in 1:dim(zips)[1]){
  tmp <- zips[i,] 
  res[[i]] <- mongo.bson.from.list(tmp)
}
mongo.insert.batch(mongo, "rmongodb.zips", res )

mongo.count(mongo, icoll)
mongo.find.all(mongo, icoll)
```


## MongoDB Aggregation Framework
JSON to BSON not yet working for this secnario
```{r}
buf <- mongo.bson.buffer.create()
mongo.bson.buffer.start.object(buf, "$group")
mongo.bson.buffer.append(buf, "_id", "$state")
mongo.bson.buffer.start.object(buf, "totalPop")
mongo.bson.buffer.append(buf, "$sum", "$pop")
mongo.bson.buffer.finish.object(buf)
mongo.bson.buffer.finish.object(buf)
bson <- mongo.bson.from.buffer(buf)

bufall <- mongo.bson.buffer.create()
mongo.bson.buffer.append(bufall, "aggregate", "zips")
mongo.bson.buffer.start.array(bufall, "pipeline")
mongo.bson.buffer.append(bufall, "0", bson)
mongo.bson.buffer.finish.object(bufall)
cmd <- mongo.bson.from.buffer(bufall)
cmd
res <- mongo.command(mongo, db, cmd)
res
```


## GridFS with rmongodb
GridFS is a specification for storing and retrieving files 
that exceed the BSON-document size limit of 16MB.
```{r}
mgrids <- mongo.gridfs.create(mongo, db, prefix = "fs")
mongo.gridfs.store.file(mgrids, "faust.txt", "Faust")
gf <- mongo.gridfs.find(mgrids, "Faust")
mongo.gridfile.get.length(gf)
mongo.gridfile.get.chunk.count(gf)



# close connection
mongo.drop.database(mongo, db)
mongo.destroy(mongo)
```



